# =========================
# üåê Nginx optimis√© avec assets statiques
# =========================
# Cette image copie les assets depuis l'image Laravel d√©j√† build√©e
# pour √©viter le probl√®me de persistence des volumes Docker
FROM ghcr.io/${GITHUB_REPOSITORY:-digipasscmr/digipass-crm}:latest AS assets

# Image finale Nginx ultra-l√©g√®re
FROM nginx:stable-alpine

# Copier la configuration Nginx personnalis√©e
COPY ./docker/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf

# Cr√©er le r√©pertoire pour les fichiers Laravel
RUN mkdir -p /var/www/public

# Copier UNIQUEMENT le dossier public depuis l'image Laravel
# Cela inclut les assets build√©s (/var/www/public/build)
COPY --from=assets /var/www/public /var/www/public

# Optimisation: supprimer les fichiers PHP du dossier public de Nginx
# (ils seront servis par php-fpm, pas Nginx)
RUN find /var/www/public -type f -name "*.php" -delete \
    && chown -R nginx:nginx /var/www/public

# Pas d'exposition de port (g√©r√© par Traefik dans Dokploy)
CMD ["nginx", "-g", "daemon off;"]
